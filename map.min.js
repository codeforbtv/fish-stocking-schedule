var Fish=Fish||{};Fish.csv_file="irene-funding-test.csv";Fish.json_file="vt.json";Fish.cloudmade_api_key="8ee2a50541944fb9bcedded5165f09d9";Fish.data_field="fema";Fish.default_color="#ccc";Fish.fill_algorithm=function(e){var t=e.properties[Fish.data_field];console.log(t);return t?color(t):Fish.default_color};Fish.get_feature_bounds=function(e){var t=e.geometry.coordinates[0],n;for(var r=0;r<t.length;r++){var i=t[r],i=new L.LatLng(i[1],i[0]);r==0&&(n=new L.LatLngBounds(i));n.extend(i)}return n};var map=new L.Map("map",{center:[43.8,-72.7],zoom:4,zoomControl:!1});map.addLayer(new L.TileLayer("http://{s}.tile.cloudmade.com/"+Fish.cloudmade_api_key+"/998/256/{z}/{x}/{y}.png"));var svg=d3.select(map.getPanes().overlayPane).append("svg"),g=svg.append("g").attr("class","leaflet-zoom-hide"),color=d3.scale.threshold().domain([1e3,1e4,5e4,1e5,2e5,5e5,1e6,25e5]).range(["#fff7ec","#fee8c8","#fdd49e","#fdbb84","#fc8d59","#ef6548","#d7301f","#b30000","#7f0000"]),y=d3.scale.sqrt().domain([0,27e5]).range([0,325]),yAxis=d3.svg.axis().scale(y).tickValues(color.domain()).orient("right");Fish.json_loaded=function(e,t){Fish.topology=t;Fish.draw_features()};Fish.draw_features=function(){function a(){var e=f(o[0]),t=f(o[1]);svg.attr("width",t[0]-e[0]).attr("height",e[1]-t[1]).style("margin-left",e[0]+"px").style("margin-top",t[1]+"px");g.attr("transform","translate("+ -e[0]+","+ -t[1]+")");Fish.feature.attr("d",u)}function f(e){var t=map.latLngToLayerPoint(new L.LatLng(e[1],e[0]));return[t.x,t.y]}var e=Fish.topology;for(var t=0;t<Fish.data.length;t++){var n="0"+Fish.data[t].zipcode;for(var r=0;r<e.objects.vermont.geometries.length;r++){var i=e.objects.vermont.geometries[r].properties.zipcode;if(n==i){e.objects.vermont.geometries[r].properties=Fish.data[t];break}}}var s=topojson.feature(e,e.objects.vermont);Fish.collection=s;var o=d3.geo.bounds(s),u=d3.geo.path().projection(f);Fish.feature=g.selectAll("path").data(s.features).enter().append("path").attr("d",u).style("fill",Fish.fill_algorithm);Fish.feature.on("mouseover",function(e){var t=d3.mouse(this)[0],n=d3.mouse(this)[1]-30;g.append("text").attr("id","tooltip").attr("x",t).attr("y",n).attr("text-anchor","middle").attr("font-family","sans-serif").attr("font-size","11px").attr("font-weight","bold").attr("fill","black").text(e.properties.town);d3.select(this).style("fill","#509e2f")});Fish.feature.on("mouseout",function(e){d3.select("#tooltip").remove();d3.select(this).attr("class")!=="active"&&d3.select(this).transition().duration(250).style("fill",Fish.fill_algorithm)});Fish.feature.on("click",function(e){var t=Fish.get_feature_bounds(e);map.fitBounds(t.pad(.25));d3.select(".active").attr("class","").style("fill",Fish.fill_algorithm);d3.select(this).attr("class","active").style("fill","#509e2f")});map.on("viewreset",a);a()};Fish.redraw_features=function(){Fish.feature.transition().duration(250).style("fill",Fish.fill_algorithm)};Fish.load_json=function(){d3.json(Fish.json_file,Fish.json_loaded)};Fish.load_csv=function(){d3.csv(Fish.csv_file,function(e){Fish.data=e;Fish.load_json()})};Fish.init_species_menu=function(){var e=$("#species ul"),t=e.find("li");t.click(function(){$(this).parent().find(".active").removeClass("active");$(this).addClass("active");Fish.data_field=$(this).data("field");Fish.redraw_features()})};$(document).ready(function(){Fish.load_csv();Fish.init_species_menu()});