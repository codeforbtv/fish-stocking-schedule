function add_commas(e){e+="";x=e.split(".");x1=x[0];x2=x.length>1?"."+x[1]:"";var t=/(\d+)(\d{3})/;while(t.test(x1))x1=x1.replace(t,"$1,$2");return x1+x2}function uniquify_array(e){var t,n=e.length,r=[],i={};for(t=0;t<n;t++)i[e[t]]=0;for(t in i)r.push(t);return r}var Fish=Fish||{};Fish.csv_file="fish.csv";Fish.json_file="vt.json";Fish.cloudmade_api_key="8ee2a50541944fb9bcedded5165f09d9";Fish.data_field="total";Fish.default_center=[44,-72.4];Fish.default_zoom=8;Fish.default_color="#ccc";Fish.ranges={Parrilla:["#fee8c8","#fdd49e","#fdbb84","#fc8d59","#ef6548","#d7301f","#b30000","#7f0000"],"Blue Green":["#CCECE6","#99D8C9","#66C2A4","#2CA25F","#006D2C","#238B45","#006D2C","#00441B"],"Blue Purple":["#BFD3E6","#9EBCDA","#8C96C6","#8856A7","#810F7C","#88419D","#810F7C","#4D004B"],"Green Blue":["#CCEBC5","#A8DDB5","#7BCCC4","#43A2CA","#0868AC","#2B8CBE","#0868AC","#084081"],"Orange Red":["#FDD49E","#FDBB84","#FC8D59","#E34A33","#B30000","#D7301F","#B30000","#7F0000"],"Purple Blue":["#D0D1E6","#A6BDDB","#74A9CF","#2B8CBE","#045A8D","#0570B0","#045A8D","#023858"]};Fish.range=Fish.ranges.Parrilla;Fish.basemaps={"Cloudmade: Fine Line":new L.TileLayer.CloudMade({key:Fish.cloudmade_api_key,styleId:1}),"Cloudmade: Fresh":new L.TileLayer.CloudMade({key:Fish.cloudmade_api_key,styleId:997}),"Cloudmade: Red Alert":new L.TileLayer.CloudMade({key:Fish.cloudmade_api_key,styleId:8}),"Cloudmade: Midnight":new L.TileLayer.CloudMade({key:Fish.cloudmade_api_key,styleId:999}),OpenStreetMap:new L.TileLayer.OpenStreetMap,OpenCycleMap:new L.TileLayer.OpenCycleMap,"Mapquest OSM":new L.TileLayer.MapQuestOpen.OSM,"Mapquest Aerial":new L.TileLayer.MapQuestOpen.Aerial,"Mapbox: World Bright":new L.TileLayer.MapBox({user:"mapbox",map:"world-bright"}),"Mapbox: Map Vyofok3q":new L.TileLayer.MapBox({user:"examples",map:"map-vyofok3q"}),"Mapbox: Iceland":new L.TileLayer.MapBox({user:"kkaefer",map:"iceland"}),"Mapbox: Natural Earth":new L.TileLayer.MapBox({user:"mapbox",map:"natural-earth-2"})};Fish.basemap_layer=Fish.basemaps["Mapquest OSM"];Fish.species_acronym_map={bkt:"Brook Trout",lat:"Lake Trout",rbt:"Rainbox Trout",stt:"Steelhead Trout",bnt:"Brown Trout",las:"Landlocked Salmon"};Fish.fill_algorithm=function(e){var t=e.properties[Fish.data_field];return t?Fish.color(t):null};Fish.get_feature_bounds=function(e){var t=e.geometry.coordinates[0],n;for(var r=0;r<t.length;r++){var i=t[r],i=new L.LatLng(i[1],i[0]);r==0&&(n=new L.LatLngBounds(i));i.lat>0&&n.extend(i)}return n};Fish.map=new L.Map("map",{center:Fish.default_center,zoom:Fish.default_zoom,zoomControl:!1});Fish.map.addLayer(Fish.basemap_layer);var svg=d3.select(Fish.map.getPanes().overlayPane).append("svg"),g=svg.append("g").attr("class","leaflet-zoom-hide");Fish.draw_features=function(){function a(){var e=f(o[0]),t=f(o[1]);svg.attr("width",t[0]-e[0]).attr("height",e[1]-t[1]).style("margin-left",e[0]+"px").style("margin-top",t[1]+"px");g.attr("transform","translate("+ -e[0]+","+ -t[1]+")");Fish.features.attr("d",u)}function f(e){var t=Fish.map.latLngToLayerPoint(new L.LatLng(e[1],e[0]));return[t.x,t.y]}var e=Fish.topology;for(var t=0;t<Fish.data.length;t++){var n="0"+Fish.data[t].parent;for(var r=0;r<e.objects.vermont.geometries.length;r++){var i=e.objects.vermont.geometries[r].properties.zipcode;if(n==i){e.objects.vermont.geometries[r].properties=Fish.data[t];break}}}var s=topojson.feature(e,e.objects.vermont);Fish.collection=s;var o=d3.geo.bounds(s),u=d3.geo.path().projection(f);Fish.features=g.selectAll("path").data(s.features).enter().append("path").attr("d",u).style("fill",Fish.fill_algorithm);Fish.features.on("mouseover",function(e){var t=d3.mouse(this)[0],n=d3.mouse(this)[1]-30;g.append("text").attr("id","tooltip").attr("x",t).attr("y",n).attr("text-anchor","middle").text(e.properties.town);d3.select(this).style("fill","#509e2f")});Fish.features.on("mouseout",function(e){d3.select("#tooltip").remove();d3.select(this).attr("class")!=="active"&&d3.select(this).transition().duration(250).style({fill:Fish.fill_algorithm,opacity:.75})});Fish.features.on("click",Fish.select_feature);Fish.map.on("viewreset",a);a()};Fish.select_feature=function(e){var t=Fish.get_feature_bounds(e),n=e.properties.town;table_rows=[];var r=Fish.data.filter(function(e){return e.parent==n});for(var i=0;i<r.length;i++){var s=r[i];$.each(Fish.species_acronym_map,function(e,t){var n=parseInt(s[e]),r=parseFloat(s[e+"-length"]),i={town:s.town,waterway:s.water,species:t,length:r,count:n};n&&table_rows.push(i)})}table_rows=table_rows.sort(function(e,t){return e.waterway>t.waterway});table_rows=table_rows.sort(function(e,t){return e.town>t.town});$("#infobox tbody tr").remove();var o=[];for(var i=0;i<table_rows.length;i++){var u=table_rows[i],a=$("<tr />");a.append($("<td />",{html:u.town}));a.append($("<td />",{html:u.waterway}));a.append($("<td />",{html:u.species}));a.append($("<td />",{html:u.length.toFixed(1)+"&rdquo;"}));a.append($("<td />",{html:add_commas(u.count)}));$("#infobox tbody").append(a);o.push(u.town)}o=uniquify_array(o);o.length===1?$("#infobox td:first-child, #infobox th:first-child").hide():$("#infobox td:first-child, #infobox th:first-child").show();$("#infobox h2").text(n);Fish.map.fitBounds(t.pad(.25));d3.select("#map .active")&&d3.select("#map .active").attr("class","").style("fill",Fish.fill_algorithm);d3.select(this).attr("class","active")};Fish.redraw_features=function(){Fish.features.transition().duration(500).style("fill",Fish.fill_algorithm)};Fish.load_json=function(){d3.json(Fish.json_file,function(e,t){Fish.topology=t;Fish.draw_features();Fish.update_zoom_control(Fish.collection.features)})};Fish.load_csv=function(){d3.csv(Fish.csv_file,function(e){Fish.data=e;Fish.build_quantiles();Fish.load_json()})};Fish.build_quantiles=function(){Fish.domain=Fish.data.map(function(e){return parseInt(e[Fish.data_field])});Fish.domain=Fish.domain.filter(function(e){return e});Fish.color=d3.scale.quantile().domain(Fish.domain).range(Fish.range)};Fish.init_species_menu=function(){var e=$("#species li");e.click(function(){$(this).parent().find(".active").removeClass("active");$(this).addClass("active");Fish.data_field=$(this).data("field");Fish.build_quantiles();Fish.redraw_features()})};Fish.init_controls=function(){var e=$("#zoom button");e.click(function(){var e=$(this).data("zoom");switch(e){case"state":Fish.map.setView(Fish.default_center,Fish.default_zoom);case"zoom-in":Fish.map.zoomIn();case"zoom-out":Fish.map.zoomOut()}});var t=$("#zcta");t.chosen();t.change(function(){var e=$(this).val(),t=Fish.collection.features,n;for(var r=0;r<t.length;r++){var i=t[r];if(i.properties.town==e){Fish.select_feature(i);break}}});var n=$("#color");n.change(function(){var e=$(this).val();Fish.range=Fish.ranges[e];Fish.color=d3.scale.quantile().domain(Fish.domain).range(Fish.range);Fish.redraw_features()});$.each(Fish.ranges,function(e,t){option=$("<option/>",{value:e,text:e});n.append(option)});n.chosen();var r=$("#basemap");r.change(function(){Fish.map.removeLayer(Fish.basemap_layer);Fish.basemap_layer=Fish.basemaps[$(this).val()];Fish.map.addLayer(Fish.basemap_layer)});$.each(Fish.basemaps,function(e,t){option=$("<option/>",{value:e,text:e});r.append(option)});r.chosen()};Fish.update_zoom_control=function(e){var t=$("#zcta");t.find("option").remove();e=e.filter(function(e){return"MASTER"==e.properties.water});for(var n=0;n<e.length;n++){var r=e[n],i=$("<option/>",{value:r.properties.town,text:r.properties.town});t.append(i)}t.trigger("liszt:updated")};$(document).ready(function(){Fish.load_csv();Fish.init_species_menu();Fish.init_controls()});